{
  "version": {
    "major": 0,
    "minor": 1,
    "patch": 0
  },
  "name": "Demo_Squmpfile",
  "requests": [
    {
      "name": "Req1",
      "script": [
        "local s = require('sqump')",
        "",
        "local resp = s.fetch('https://pokeapi.co/api/v2/pokemon/{{.pokemon}}')",
        "",
        "-- s.print_response(resp)",
        "",
        "print(s.drill_json('id', resp.body), s.drill_json('types.1.type.name', resp.body))",
        "",
        "s.export({",
        "  pokemon = resp.body,",
        "})"
      ]
    },
    {
      "name": "Req2",
      "script": [
        "local s = require('sqump')",
        "",
        "local res = s.execute('Req1')",
        "",
        "local weight = s.drill_json('weight', res.pokemon)",
        "local id = s.drill_json('id', res.pokemon)",
        "",
        "local k = require('sqump_kafka')",
        "local brokers = {'localhost:9092'}",
        "local topic = 'weights'",
        "",
        "k.provision_topic(brokers, topic)",
        "",
        "local p = k.new_producer(brokers, topic, 5)",
        "p:write(tostring(id), tostring(weight))",
        "p:close()",
        "print('done writing!')"
      ]
    },
    {
      "name": "Req3",
      "script": [
        "local k = require('sqump_kafka')",
        "",
        "local brokers = {'localhost:9092'}",
        "local topic = 'weights'",
        "",
        "math.randomseed(os.time())",
        "local c = k.new_consumer(brokers, string.format(\"group-%d\", math.random(1, 1000)), topic, 'first')",
        "",
        "local sum, count = 0, 0",
        "while true do",
        "  local msg = c:read_message(5, false)",
        "  if msg == nil then",
        "    break",
        "  end",
        "  sum = sum + tonumber(msg.data)",
        "  count = count + 1",
        "end",
        "c:close()",
        "",
        "print('Total weight:', sum)",
        "print('Average:', sum / count)"
      ]
    }
  ],
  "environment": {
    "prod": {
      "pokemon": "psyduck"
    },
    "staging": {
      "pokemon": "snorlax"
    }
  }
}